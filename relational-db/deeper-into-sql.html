<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<style>
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>
<title>Normalized Design</title>

</head>
<body>
<h2>Normalized Design</h2>

<p>Check out William Kent's paper "<a href="http://www.bkent.net/Doc/simple5.htm">A Simple Guide to Five Normal Forms in Relational Database Theory</a>" for a lot more about normalization and how it can help your database design.</p>

<p>In a <strong>normalized</strong> database, the relationships among the tables match the relationships that are really there among the data.</p>

<ol>
<li><p>every row has the same number of columns
 <img src="img/1st-rule.png" alt="" />
 (well, i guess the current DBMS doesn't let you do this anyways)</p></li>
<li><p>there is a unique <strong>key</strong>, and everything in a row says something about the key
 <img src="img/2nd-rule.png" alt="" />
 the rest of row contains data related of the key</p></li>
<li><p>stuff that don't relate to the key should go to different tables<br/>
 before:
 <img src="img/3rd-rule-before.png" alt="" />
 item: unique key<br/>
 count: item's count [related:<strong>YES</strong>]
 location: item's location [related:<strong>YES</strong>]
 address: location's address [related:<strong>NO</strong>]</p>

<p> after:
 <img src="img/3rd-rule-after.png" alt="" /></p></li>
<li><p>tables shouldn't imply relationships that don't exist<br/>
 before:
 <img src="img/4th-rule-before.png" alt="" />
 technology and langauge are independent and has no relationship, so they shouldn't be in the same table.<br/>
 after:
 <img src="img/4th-rule-after.png" alt="" /></p></li>
</ol>


<p>You will sometimes hear about denormalization as an approach to making database queries faster by avoiding joins. This is an advanced topic beyond the scope of this course. But if you're interested in it, on modern database systems (such as PostgreSQL) it is often possible to meet the same goals using tools such as <a href="http://www.postgresql.org/docs/9.4/static/sql-createindex.html">indexes</a> and <a href="http://www.postgresql.org/docs/9.4/static/sql-creatematerializedview.html">materialized views</a>.</p>

<p><img src="img/normalized-quiz.png" alt="" /></p>

<h2>Create Table and Types</h2>

<p><img src="img/create-table.png" alt="" /></p>

<pre><code>vagrant@vagrant:~$ psql
psql (9.3.6)
Type "help" for help.

vagrant=&gt; create database fishies;
CREATE DATABASE
vagrant=&gt; \c fishies
You are now connected to database "fishies" as user "vagrant".
fishies=&gt; create table sashimi (id serial, name text);
CREATE TABLE
fishies=&gt; select * from sashimi;
 id | name 
----+------
(0 rows)

fishies=&gt; insert into sashimi (name) values ('tuna');
INSERT 0 1
fishies=&gt; select * from sashimi;
 id | name 
----+------
  1 | tuna
(1 row)

fishies=&gt; 
</code></pre>

<p>For more detail on the serial type, take a look at the last section of this page in the PostgreSQL manual:</p>

<p><a href="http://www.postgresql.org/docs/9.4/static/datatype-numeric.html">http://www.postgresql.org/docs/9.4/static/datatype-numeric.html</a></p>

<p><img src="img/create-and-drop1.png" alt="" />
<img src="img/create-and-drop2.png" alt="" /></p>

<h2>Primary keys</h2>

<p>a column or columns that uniquely identify what each row in a table is about</p>

<p>single-column primary key:</p>

<pre><code>create table students(
    id serial primary key,
    name text,
    birthday date
);
</code></pre>

<p>multi-column primary key:</p>

<pre><code>create table postal_pages (
    postal_code text,
    country text,
    name text,
    primary key (postal_code, country)
);
</code></pre>

<p><img src="img/primary-key-quiz.png" alt="" />
If we set up a constraint (such as a primary key) we're asking for the database to help ensure that our data makes sense.</p>

<p>By signaling an error, the database refuses to accept data that break the "rule" that we've created by adding a primary key constraint.</p>

<h2>Declaring relationships</h2>

<p><img src="img/declare-relationship.png" alt="" /></p>

<pre><code>create table sales (
    sku text references products (sku),
    sale_date date,
    count integer
)
</code></pre>

<p><strong>references</strong> provides referential integrity - columns that are supposed to refer to each other are guaranteed to do so</p>

<h2>Foreign Keys</h2>

<p>A <strong>foreign key</strong> is a column or set of columns in one table, that uniquely identifies rows in another table
<img src="img/foreign-key-1.png" alt="" />
<img src="img/foreign-key-2.png" alt="" /></p>

<h2>Self Joins</h2>

<p>list of residents table:</p>

<pre><code>select id, building, room from residences;
+--------+----------+------+
|     id | building | room |
+========+==========+======+
| 104131 | Dolliver |   14 |
| 105540 | Kendrick |   3B |
| 118199 | Kendrick |   1A |
| 161282 | Dolliver |    7 |
| 170267 | Dolliver |    1 |
| 231742 | Kendrick |   3B |
| 250841 | Kendrick |   2B |
| 410315 |   Crosby |   20 |
| 413001 |   Crosby |   10 |
| 427611 | Dolliver |   10 |
| 477801 | Dolliver |    8 |
| 496747 |   Crosby |   19 |
| 498446 |   Crosby |   21 |
| 505241 | Dolliver |    8 |
| 612413 |   Crosby |   31 |
| 707536 | Dolliver |   14 |
| 741532 |   Crosby |   19 |
| 762907 | Dolliver |    9 |
| 824292 | Kendrick |   1A |
| 851866 |   Crosby |   22 |
| 881256 |   Crosby |   10 |
| 931027 |   Crosby |   31 |
| 958827 | Dolliver |    1 |
+--------+----------+------+
</code></pre>

<p>find pairs of roommates:</p>

<pre><code>select 
    a.id, b.id, a.building, a.room
from 
    residences as a, residences as b
where 
    a.building = b.building
    and 
    a.room = b.room
    and 
    a.id &lt; b.id
order by 
    a.building, a.room;

+--------+--------+----------+------+
|     id |     id | building | room |
+========+========+==========+======+
| 881256 | 413001 |   Crosby |   10 |
| 741532 | 496747 |   Crosby |   19 |
| 931027 | 612413 |   Crosby |   31 |
| 958827 | 170267 | Dolliver |    1 |
| 707536 | 104131 | Dolliver |   14 |
| 505241 | 477801 | Dolliver |    8 |
| 824292 | 118199 | Kendrick |   1A |
| 231742 | 105540 | Kendrick |   3B |
+--------+--------+----------+------+
</code></pre>

<h2>Counting what isn’t there</h2>

<p>Counting rows in a single table is something you’ve seen many times before in this course. A column aggregated with the count aggregation function will return the number of rows in the table, or the number of rows for each value of a group by clause.</p>

<p>For instance, you saw queries like these back in Lesson 2:</p>

<p><code>select count(*) from animals;</code><br/>
-- returns the number of animals in the zoo</p>

<p><code>select count(*) from animals where species = ‘gorilla’;</code><br/>
-- returns the number of gorillas</p>

<p><code>select species, count(*) from animals group by species;</code><br/>
-- returns each species’ name and the number of animals of that species</p>

<p>Things get a little more complicated if you want to count the results of a <strong>join</strong>. Consider these tables we saw earlier in Lesson 4, the <strong>products</strong> and <strong>sales</strong> tables for a store:</p>

<p><img src="img/counting.png" alt="" /></p>

<p>Suppose that we want to know how many times we have sold each product. In other words, for each <strong>sku</strong> value in the <strong>products</strong> table, we want to know the number of times it occurs in the sales table. We might start out with a query like this:</p>

<pre><code>select products.name, products.sku, count(*) as num
  from products join sales
    on products.sku = sales.sku
  group by products.sku;
</code></pre>

<p>But this query might not do exactly what we want. If a particular <strong>sku</strong> has never been sold — if there are no entries for it in the <strong>sales</strong> table — then this query will not return a row for it at all.</p>

<p>If we wanted to see a row with the number zero in it, we’ll be disappointed!</p>

<p>However, there is a way to get the database to give us a count with a zero in it. To do this, we’ll need to change two things about this query —</p>

<pre><code>select products.name, products.sku, count(sales.sku) as num
  from products left join sales
    on products.sku = sales.sku
  group by products.sku;
</code></pre>

<p>This query will give us a row for every product in the <strong>products</strong> table, even the ones that have no sales in the <strong>sales</strong> table.</p>

<p>What’s changed? First, we’re using <strong>count(sales.sku)</strong> instead of <strong>count(*)</strong>. This means that the database will count only rows where <strong>sales.sku</strong> is defined, instead of all rows.</p>

<p>Second, we’re using a <strong>left join</strong> instead of a plain <strong>join</strong>.</p>

<h3>Um, so what’s a left join?</h3>

<p>SQL supports a number of variations on the theme of joins. The kind of join that you have seen earlier in this course is called an inner join, and it is the most common kind of join — so common that SQL doesn’t actually make us say "inner join" to do one.</p>

<p>But the second most common is the <strong>left join</strong>, and its mirror-image partner, the <strong>right join</strong>. The words “left” and “right” refer to the tables to the left and right of the join operator. (Above, the left table is <strong>products</strong> and the right table is <strong>sales</strong>.)</p>

<p>A regular (inner) join returns only those rows where the two tables have entries matching the join condition. A <strong>left join</strong> returns all those rows, plus the rows where the left table has an entry but the right table doesn’t. And a <strong>right join</strong> does the same but for the right table.</p>

<p>(Just as “join” is short for “inner join”, so too is “left join” actually short for “left outer join”. But SQL lets us just say “left join”, which is a lot less typing. So we’ll do that.)</p>

<pre><code># In this quiz, there's a table describing bugs in various files of code.
# Here's what the table looks like:
#
# create table programs (
#    name text,
#    filename text
# );
# create table bugs (
#    filename text,
#    description text,
#    id serial primary key
# );
#
# The query below is intended to count the number of bugs in each program. But
# it doesn't return a row for any program that has zero bugs.  Try running it as
# it is; then change it so that it includes rows for the programs with no bugs.

QUERY = '''
select programs.name, count(bugs.id) as num
   from programs left join bugs
        on programs.filename = bugs.filename
   group by programs.name
   order by num;
'''
</code></pre>

<h2>Subqueries</h2>

<p><img src="img/subquery-1.png" alt="" />
<img src="img/subquery-2.png" alt="" />
<img src="img/subquery-3.png" alt="" />
<img src="img/subquery-4.png" alt="" /></p>

<pre><code># Find the players whose weight is less than the average.
# 
# The function below performs two database queries in order to find the right players.
# Refactor this code so that it performs only one query.
#

def lightweights(cursor):
    """Returns a list of the players in the db whose weight is less than the average."""
    #cursor.execute("select avg(weight) as av from players;")
    #av = cursor.fetchall()[0][0]  # first column of first (and only) row
    cursor.execute("select name, weight from players, (select avg(weight) as av from players) as p_weight where weight &lt; p_weight.av")
    return cursor.fetchall()
</code></pre>

<p><img src="img/subquery-quiz.png" alt="" /></p>

<h2>Views</h2>

<p>A <strong>view</strong> is a <strong>select</strong> query stored in the database in a way that lets you use it like a table</p>

<pre><code>create view viewname as select...
</code></pre>

<p><img src="img/view-1.png" alt="" />
<img src="img/view-quiz.png" alt="" /></p>
</body>
</html>